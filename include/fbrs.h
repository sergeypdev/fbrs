#ifndef FBRS_H
#define FBRS_H

#include <emmintrin.h>

#define CPU_X64

#ifdef _MSC_VER
#define ABI_WIN64
#else
#define ABI_SYSV
#endif

struct fbrs_context_t {
  // put registers here
#ifdef CPU_X64

#ifdef ABI_SYSV
  void *rip, *rsp;
  void *rbx, *rbp, *r12, *r13, *r14, *r15;
#endif // ABI_SYSV

#ifdef ABI_WIN64
  void *rip, *rsp;
  void *rbx, *rbp, *rsi, *rdi, *r12, *r13, *r14, *r15;
  __m128 xmm6, xmm7, xmm8, xmm9, xmm10, xmm11, xmm12, xmm13, xmm14, xmm15;
#endif // ABI_WIN64

#endif // CPU_X64
};

int fbrs_id();

void fbrs_save_context(struct fbrs_context_t *context);
void fbrs_load_context(struct fbrs_context_t *context);
void fbrs_switch_context(struct fbrs_context_t *old_context,
                         struct fbrs_context_t *new_context);

struct fbrs_context_t *fbrs_current_context();

#endif // FBRS_H

#define FBRS_IMPLEMENTATION

#ifdef FBRS_IMPLEMENTATION

#ifdef _MSC_VER
#define DECL_SECTION_TEXT                                                      \
  __pragma(section(".text")) __declspec(allocate(".text"))

#define THREAD_LOCAL __declspec(thread)
#else
#define DECL_SECTION_TEXT __attribute__((section(".text#")))

#define THREAD_LOCAL __thread
#endif

// Save, load and
#ifdef CPU_X64

#ifdef ABI_SYSV

DECL_SECTION_TEXT unsigned char fbrs_save_context_code[] = {
    0x4c, 0x8b, 0x04, 0x24,       // mov    (%rsp), %r8
    0x4c, 0x89, 0x07,             // mov       %r8, (%rdi)
    0x4c, 0x8d, 0x44, 0x24, 0x08, // lea 0x8(%rsp), %r8
    0x4c, 0x89, 0x47, 0x08,       // mov       %r8, 0x8(%rdi)
    0x48, 0x89, 0x5f, 0x10,       // mov      %rbx, 0x10(%rdi)
    0x48, 0x89, 0x6f, 0x18,       // mov      %rbp, 0x18(%rdi)
    0x4c, 0x89, 0x67, 0x20,       // mov      %r12, 0x20(%rdi)
    0x4c, 0x89, 0x6f, 0x28,       // mov      %r13, 0x28(%rdi)
    0x4c, 0x89, 0x77, 0x30,       // mov      %r14, 0x30(%rdi)
    0x4c, 0x89, 0x7f, 0x38,       // mov      %r15, 0x38(%rdi)
    0x31, 0xc0,                   // xor      %eax, %eax
    0xc3,                         // ret
};

DECL_SECTION_TEXT unsigned char fbrs_load_context_code[] = {
    0x4c, 0x8b, 0x07,       // mov       (%rdi), %r8
    0x48, 0x8b, 0x67, 0x08, // mov    0x8(%rdi), %rsp
    0x48, 0x8b, 0x5f, 0x10, // mov   0x10(%rdi), %rbx
    0x48, 0x8b, 0x6f, 0x18, // mov   0x18(%rdi), %rbp
    0x4c, 0x8b, 0x67, 0x20, // mov   0x20(%rdi), %r12
    0x4c, 0x8b, 0x6f, 0x28, // mov   0x28(%rdi), %r13
    0x4c, 0x8b, 0x77, 0x30, // mov   0x30(%rdi), %r14
    0x4c, 0x8b, 0x7f, 0x38, // mov   0x38(%rdi), %r15
    0x41, 0x50,             // push         %r8
    0x31, 0xc0,             // xor         %eax, %eax
    0xc3,                   // ret
};

DECL_SECTION_TEXT unsigned char fbrs_switch_context_code[] = {
    0x4c, 0x8b, 0x04, 0x24,       // mov    (%rsp),%r8
    0x4c, 0x89, 0x07,             // mov    %r8,(%rdi)
    0x4c, 0x8d, 0x44, 0x24, 0x08, // lea    0x8(%rsp),%r8
    0x4c, 0x89, 0x47, 0x08,       // mov    %r8,0x8(%rdi)
    0x48, 0x89, 0x5f, 0x10,       // mov    %rbx,0x10(%rdi)
    0x48, 0x89, 0x6f, 0x18,       // mov    %rbp,0x18(%rdi)
    0x4c, 0x89, 0x67, 0x20,       // mov    %r12,0x20(%rdi)
    0x4c, 0x89, 0x6f, 0x28,       // mov    %r13,0x28(%rdi)
    0x4c, 0x89, 0x77, 0x30,       // mov    %r14,0x30(%rdi)
    0x4c, 0x89, 0x7f, 0x38,       // mov    %r15,0x38(%rdi)
    0x4c, 0x8b, 0x06,             // mov    (%rsi),%r8
    0x48, 0x8b, 0x66, 0x08,       // mov    0x8(%rsi),%rsp
    0x48, 0x8b, 0x5e, 0x10,       // mov    0x10(%rsi),%rbx
    0x48, 0x8b, 0x6e, 0x18,       // mov    0x18(%rsi),%rbp
    0x4c, 0x8b, 0x66, 0x20,       // mov    0x20(%rsi),%r12
    0x4c, 0x8b, 0x6e, 0x28,       // mov    0x28(%rsi),%r13
    0x4c, 0x8b, 0x76, 0x30,       // mov    0x30(%rsi),%r14
    0x4c, 0x8b, 0x7e, 0x38,       // mov    0x38(%rsi),%r15
    0x41, 0x50,                   // push   %r8
    0x31, 0xc0,                   // xor    %eax,%eax
    0xc3,                         // ret
};
#endif // ABI_SYSV

#ifdef ABI_WIN64

DECL_SECTION_TEXT unsigned char fbrs_save_context_code[] = {
    0x4c, 0x8b, 0x04, 0x24,       // mov    (%rsp),%r8
    0x4c, 0x89, 0x01,             // mov    %r8,(%rcx)
    0x4c, 0x8d, 0x44, 0x24, 0x08, // lea    0x8(%rsp),%r8
    0x4c, 0x89, 0x41, 0x08,       // mov    %r8,0x8(%rcx)
    0x48, 0x89, 0x59, 0x10,       // mov    %rbx,0x10(%rcx)
    0x48, 0x89, 0x69, 0x18,       // mov    %rbp,0x18(%rcx)
    0x48, 0x89, 0x71, 0x20,       // mov    %rsi,0x20(%rcx)
    0x48, 0x89, 0x79, 0x28,       // mov    %rdi,0x28(%rcx)
    0x4c, 0x89, 0x61, 0x30,       // mov    %r12,0x30(%rcx)
    0x4c, 0x89, 0x69, 0x38,       // mov    %r13,0x38(%rcx)
    0x4c, 0x89, 0x71, 0x40,       // mov    %r14,0x40(%rcx)
    0x4c, 0x89, 0x79, 0x48,       // mov    %r15,0x48(%rcx)
    0x0f, 0x11, 0x71, 0x50,       // movups %xmm6,0x50(%rcx)
    0x0f, 0x11, 0x79, 0x60,       // movups %xmm7,0x60(%rcx)
    0x44, 0x0f, 0x11, 0x41, 0x70, // movups %xmm8,0x70(%rcx)
    0x44, 0x0f, 0x11, 0x89, 0x80, //
    0x00, 0x00, 0x00,             // movups %xmm9,0x80(%rcx)
    0x44, 0x0f, 0x11, 0x91, 0x90, //
    0x00, 0x00, 0x00,             // movups %xmm10,0x90(%rcx)
    0x44, 0x0f, 0x11, 0x99, 0xa0, //
    0x00, 0x00, 0x00,             // movups %xmm11,0xa0(%rcx)
    0x44, 0x0f, 0x11, 0xa1, 0xb0, //
    0x00, 0x00, 0x00,             // movups %xmm12,0xb0(%rcx)
    0x44, 0x0f, 0x11, 0xa9, 0xc0, //
    0x00, 0x00, 0x00,             // movups %xmm13,0xc0(%rcx)
    0x44, 0x0f, 0x11, 0xb1, 0xd0, //
    0x00, 0x00, 0x00,             // movups %xmm14,0xd0(%rcx)
    0x44, 0x0f, 0x11, 0xb9, 0xe0, //
    0x00, 0x00, 0x00,             // movups %xmm15,0xe0(%rcx)
    0x31, 0xc0,                   // xor    %eax,%eax
    0xc3,                         // ret
};

DECL_SECTION_TEXT unsigned char fbrs_load_context_code[] = {
    0x4c, 0x8b, 0x01,             // mov    (%rcx),%r8
    0x48, 0x8b, 0x61, 0x08,       // mov    0x8(%rcx),%rsp
    0x48, 0x8b, 0x59, 0x10,       // mov    0x10(%rcx),%rbx
    0x48, 0x8b, 0x69, 0x18,       // mov    0x18(%rcx),%rbp
    0x48, 0x8b, 0x71, 0x20,       // mov    0x20(%rcx),%rsi
    0x48, 0x8b, 0x79, 0x28,       // mov    0x28(%rcx),%rdi
    0x4c, 0x8b, 0x61, 0x30,       // mov    0x30(%rcx),%r12
    0x4c, 0x8b, 0x69, 0x38,       // mov    0x38(%rcx),%r13
    0x4c, 0x8b, 0x71, 0x40,       // mov    0x40(%rcx),%r14
    0x4c, 0x8b, 0x79, 0x48,       // mov    0x48(%rcx),%r15
    0x0f, 0x10, 0x71, 0x50,       // movups 0x50(%rcx),%xmm6
    0x0f, 0x10, 0x79, 0x60,       // movups 0x60(%rcx),%xmm7
    0x44, 0x0f, 0x10, 0x41, 0x70, // movups 0x70(%rcx),%xmm8
    0x44, 0x0f, 0x10, 0x89, 0x80, //
    0x00, 0x00, 0x00,             // movups 0x80(%rcx),%xmm9
    0x44, 0x0f, 0x10, 0x91, 0x90, //
    0x00, 0x00, 0x00,             // movups 0x90(%rcx),%xmm10
    0x44, 0x0f, 0x10, 0x99, 0xa0, //
    0x00, 0x00, 0x00,             // movups 0xa0(%rcx),%xmm11
    0x44, 0x0f, 0x10, 0xa1, 0xb0, //
    0x00, 0x00, 0x00,             // movups 0xb0(%rcx),%xmm12
    0x44, 0x0f, 0x10, 0xa9, 0xc0, //
    0x00, 0x00, 0x00,             // movups 0xc0(%rcx),%xmm13
    0x44, 0x0f, 0x10, 0xb1, 0xd0, //
    0x00, 0x00, 0x00,             // movups 0xd0(%rcx),%xmm14
    0x44, 0x0f, 0x10, 0xb9, 0xe0, //
    0x00, 0x00, 0x00,             // movups 0xe0(%rcx),%xmm15
    0x41, 0x50,                   // push   %r8
    0x31, 0xc0,                   // xor    %eax,%eax
    0xc3,                         // ret
};

DECL_SECTION_TEXT unsigned char fbrs_switch_context_code[] = {
    0x4c, 0x8b, 0x04, 0x24,                   //  mov    (%rsp),%r8
    0x4c, 0x89, 0x01,                         //  mov    %r8,(%rcx)
    0x4c, 0x8d, 0x44, 0x24, 0x08,             //  lea    0x8(%rsp),%r8
    0x4c, 0x89, 0x41, 0x08,                   //  mov    %r8,0x8(%rcx)
    0x48, 0x89, 0x59, 0x10,                   //  mov    %rbx,0x10(%rcx)
    0x48, 0x89, 0x69, 0x18,                   //  mov    %rbp,0x18(%rcx)
    0x48, 0x89, 0x71, 0x20,                   //  mov    %rsi,0x20(%rcx)
    0x48, 0x89, 0x79, 0x28,                   //  mov    %rdi,0x28(%rcx)
    0x4c, 0x89, 0x61, 0x30,                   //  mov    %r12,0x30(%rcx)
    0x4c, 0x89, 0x69, 0x38,                   //  mov    %r13,0x38(%rcx)
    0x4c, 0x89, 0x71, 0x40,                   //  mov    %r14,0x40(%rcx)
    0x4c, 0x89, 0x79, 0x48,                   //  mov    %r15,0x48(%rcx)
    0x0f, 0x11, 0x71, 0x50,                   //  movups %xmm6,0x50(%rcx)
    0x0f, 0x11, 0x79, 0x60,                   //  movups %xmm7,0x60(%rcx)
    0x44, 0x0f, 0x11, 0x41, 0x70,             //    movups %xmm8,0x70(%rcx)
    0x44, 0x0f, 0x11, 0x89, 0x80, 0x00, 0x00, //   movups %xmm9,0x80(%rcx)
    0x00, 0x44, 0x0f, 0x11, 0x91, 0x90, 0x00,
    0x00, //   movups %xmm10,0x90(%rcx)
    0x00, 0x44, 0x0f, 0x11, 0x99, 0xa0, 0x00,
    0x00, //   movups %xmm11,0xa0(%rcx)
    0x00, 0x44, 0x0f, 0x11, 0xa1, 0xb0, 0x00,
    0x00, //   movups %xmm12,0xb0(%rcx)
    0x00, 0x44, 0x0f, 0x11, 0xa9, 0xc0, 0x00,
    0x00, //   movups %xmm13,0xc0(%rcx)
    0x00, 0x44, 0x0f, 0x11, 0xb1, 0xd0, 0x00,
    0x00, //   movups %xmm14,0xd0(%rcx)
    0x00, 0x44, 0x0f, 0x11, 0xb9, 0xe0, 0x00,
    0x00,                                     //   movups %xmm15,0xe0(%rcx)
    0x00, 0x4c, 0x8b, 0x02,                   //    mov    (%rdx),%r8
    0x48, 0x8b, 0x62, 0x08,                   //    mov    0x8(%rdx),%rsp
    0x48, 0x8b, 0x5a, 0x10,                   //    mov    0x10(%rdx),%rbx
    0x48, 0x8b, 0x6a, 0x18,                   //    mov    0x18(%rdx),%rbp
    0x48, 0x8b, 0x72, 0x20,                   //    mov    0x20(%rdx),%rsi
    0x48, 0x8b, 0x7a, 0x28,                   //    mov    0x28(%rdx),%rdi
    0x4c, 0x8b, 0x62, 0x30,                   //    mov    0x30(%rdx),%r12
    0x4c, 0x8b, 0x6a, 0x38,                   //    mov    0x38(%rdx),%r13
    0x4c, 0x8b, 0x72, 0x40,                   //    mov    0x40(%rdx),%r14
    0x4c, 0x8b, 0x7a, 0x48,                   //    mov    0x48(%rdx),%r15
    0x0f, 0x10, 0x72, 0x50,                   //    movups 0x50(%rdx),%xmm6
    0x0f, 0x10, 0x7a, 0x60,                   //    movups 0x60(%rdx),%xmm7
    0x44, 0x0f, 0x10, 0x42, 0x70,             //   movups 0x70(%rdx),%xmm8
    0x44, 0x0f, 0x10, 0x8a, 0x80, 0x00, 0x00, //  movups 0x80(%rdx),%xmm9
    0x00, 0x44, 0x0f, 0x10, 0x92, 0x90, 0x00,
    0x00, //  movups 0x90(%rdx),%xmm10
    0x00, 0x44, 0x0f, 0x10, 0x9a, 0xa0, 0x00,
    0x00, //  movups 0xa0(%rdx),%xmm11
    0x00, 0x44, 0x0f, 0x10, 0xa2, 0xb0, 0x00,
    0x00, //  movups 0xb0(%rdx),%xmm12
    0x00, 0x44, 0x0f, 0x10, 0xaa, 0xc0, 0x00,
    0x00, //  movups 0xc0(%rdx),%xmm13
    0x00, 0x44, 0x0f, 0x10, 0xb2, 0xd0, 0x00,
    0x00, //  movups 0xd0(%rdx),%xmm14
    0x00, 0x44, 0x0f, 0x10, 0xba, 0xe0, 0x00,
    0x00,             //  movups 0xe0(%rdx),%xmm15
    0x00, 0x41, 0x50, //     push   %r8
    0x31, 0xc0,       //     xor    %eax,%eax
    0xc3,             //   ret
};

#endif // ABI_WIN64

#endif // CPU_X64

static THREAD_LOCAL struct fbrs_context_t *current_fiber = NULL;

struct fbrs_context_t *fbrs_current_context() { return current_fiber; }

void fbrs_set_current_context(struct fbrs_context_t *context) {
  current_fiber = context;
}

static void (*fbrs_save_context_impl)(struct fbrs_context_t *) =
    (void (*)(struct fbrs_context_t *))fbrs_save_context_code;

static void (*fbrs_load_context_impl)(struct fbrs_context_t *) =
    (void (*)(struct fbrs_context_t *))fbrs_load_context_code;

static void (*fbrs_switch_context_impl)(struct fbrs_context_t *,
                                        struct fbrs_context_t *) =
    (void (*)(struct fbrs_context_t *,
              struct fbrs_context_t *))fbrs_switch_context_code;

void fbrs_save_context(struct fbrs_context_t *context) {
  fbrs_save_context_impl(context);
}

void fbrs_load_context(struct fbrs_context_t *context) {
  // struct fbrs_context_t *old_context = fbrs_current_context();
  // fbrs_set_current_context(context);
  fbrs_load_context_impl(context);
  // fbrs_set_current_context(old_context);
}

void fbrs_switch_context(struct fbrs_context_t *old_context,
                         struct fbrs_context_t *new_context) {
  fbrs_set_current_context(new_context);
  fbrs_switch_context_impl(old_context, new_context);
  fbrs_set_current_context(old_context);
}

#endif
